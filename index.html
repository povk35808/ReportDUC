<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>កម្មវិធីកត់ត្រាចំណាយ</title>
  
  <!-- (NEW) Add Favicon -->
  <link rel="shortcut icon" href="https://postimg.cc/qtcv1RC1" type="image/x-icon">
  
  <!-- 1. ទាញយក Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. ទាញយក React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- 3. ទាញយក Babel (ដើម្បីបកប្រែ JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 4. ទាញយក Firebase SDKs -->
  <!-- (FIX) ត្រូវតែប្រើ 'compat' scripts ដើម្បីឱ្យ 'firebase' global object ដំណើរការ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    /* ប្រើ Font ខ្មែរ */
    body {
      font-family: 'Inter', 'Kantumruy Pro', sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap');
    
    /* (NEW) Animation for page fade-in */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .page-fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100">
  
  <!-- 5. HTML Root Element -->
  <div id="root"></div>

  <!-- 6. កូដ React (បានចម្លងពី App.jsx និងកែសម្រួល) -->
  <script type="text/babel">

      const { useState, useEffect, useMemo } = React;
      
      // --- (NEW) Global Helper Functions សម្រាប់ Format លេខ ---
      // ប្រើ en-US សម្រាប់សញ្ញាក្បៀស (,)
      const formatDisplayAmount = (amount) => {
        if (!amount) return '';
        const num = Number(amount);
        if (isNaN(num)) return '';
        return num.toLocaleString('en-US');
      };
      
      const parseAmount = (value) => {
        if (typeof value !== 'string') return value;
        return value.replace(/,/g, ''); // លុបសញ្ញាក្បៀសចេញ
      };
      // --------------------------------------------------

      // --- ត្រូវប្រាកដថាអថេរទាំងនេះមាន ---
      // (Canvas នឹងផ្តល់អថេរទាំងនេះដោយស្វ័យប្រវត្តិ)
      const injectedConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : null;
        
      // ---!!! សំខាន់ណាស់ !!!---
      // សូមយក Firebase Config របស់អ្នកមកដាក់ជំនួស Object ទទេ ខាងក្រោម
      // អ្នកអាចរក Config នេះបានពី Firebase Console -> Project Settings
      const manualConfig = {
        apiKey: "AIzaSyDmfuDO3sQEzgpjIP_I6s1UxxCJdcc1nNI",
        authDomain: "mypayment-b5440.firebaseapp.com",
        databaseURL: "https://mypayment-b5440-default-rtdb.firebaseio.com",
        projectId: "mypayment-b5440",
        storageBucket: "mypayment-b5440.firebasestorage.app",
        messagingSenderId: "376342723543",
        appId: "1:376342723543:web:1714e31cab7d177258e992",
        measurementId: "G-157Y9CQTTG"
      };
      // ------------------------------------

      const firebaseConfig = injectedConfig || manualConfig;

      // (FIX) ត្រូវតែប្រើ projectId ជានិច្ច ដើម្បីឱ្យ Realtime ដំណើរការឆ្លងឧបករណ៍
      const rawAppId = firebaseConfig.projectId || 'default-app-id';
      
      // Firebase Realtime Database paths can't contain '.', '#', '$', '[', or ']'
      // We must sanitize the appId by replacing invalid characters.
      const appId = rawAppId.replace(/[.#$\[\]]/g, '_');

      const initialAuthToken = typeof __initial_auth_token !== 'undefined' 
        ? __initial_auth_token 
        : null;

      // --- ចាប់ផ្តើម Firebase ---
      let app, auth, rtdb; // លុប db (Firestore) ចេញ, នៅតែ rtdb
      try {
        // (FIX) ប្រើ v8/compat syntax
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth(app);
        rtdb = firebase.database(app); // សម្រាប់ Headers និង Expenses (Public)
      } catch (e) {
        console.error("Error initializing Firebase: ", e);
      }

      // --- Component សម្រាប់គ្រប់គ្រងឈ្មោះចំណាយ (ExpenseTemplateManager) ---
      function ExpenseTemplateManager({ expenseTemplates, addExpenseTemplate, deleteExpenseTemplate }) {
        const [newTemplateName, setNewTemplateName] = useState('');

        const handleAddTemplate = (e) => {
          e.preventDefault();
          if (newTemplateName.trim()) {
            addExpenseTemplate(newTemplateName.trim());
            setNewTemplateName('');
          }
        };

        return (
          <div className="mb-8 p-6 bg-white shadow-md rounded-lg transition-all duration-300 ease-in-out hover:shadow-xl">
            <h2 className="text-2xl font-semibold mb-4 text-gray-800">គ្រប់គ្រងឈ្មោះចំណាយ (Headers)</h2>
            <form onSubmit={handleAddTemplate} className="flex flex-col sm:flex-row gap-2 mb-4">
              <input
                type="text"
                value={newTemplateName}
                onChange={(e) => setNewTemplateName(e.target.value)}
                placeholder="ឧទា៖ ថ្លៃបាយ, ថ្លៃសាំង, ថ្លៃផ្ទះ..."
                className="flex-grow p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
              />
              <button
                type="submit"
                className="p-3 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 transition-transform duration-200 ease-in-out hover:scale-105 active:scale-95"
              >
                បន្ថែមឈ្មោះចំណាយ
              </button>
            </form>
            
            <div className="flex flex-wrap gap-2">
              {expenseTemplates.length === 0 && <p className="text-gray-500">មិនទាន់មានឈ្មោះចំណាយ...</p>}
              {expenseTemplates.map((template) => (
                <span
                  key={template.id}
                  className="flex items-center bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-medium"
                >
                  {template.name}
                  <button
                    onClick={() => deleteExpenseTemplate(template.id)}
                    className="ml-2 text-red-500 hover:text-red-700 font-bold transition-transform duration-200 hover:scale-110"
                  >
                    &times;
                  </button>
                </span>
              ))}
            </div>
          </div>
        );
      }


      // --- Component សម្រាប់បង្ហាញតារាង "បញ្ចូល" ទិន្នន័យ (Batch Input Table) ---
      function BatchExpenseForm({ addExpense, expenseTemplates, loading, setLoading }) {
        const defaultDate = new Date().toISOString().split('T')[0];
        const createNewRow = () => ({
          id: crypto.randomUUID(), // ID សម្រាប់ React state
          expenseName: expenseTemplates.length > 0 ? expenseTemplates[0].name : '',
          amount: '',
          date: defaultDate,
        });

        // (NEW) កំណត់ Key សម្រាប់ localStorage
        const DRAFT_KEY = `expense_drafts_${appId}`;

        // (FIX) ប្រើ Lazy Initializer សម្រាប់ useState ដើម្បីទាញទិន្នន័យពី localStorage ពេលចាប់ផ្តើម
        const [rows, setRows] = useState(() => {
          try {
            const savedDrafts = localStorage.getItem(DRAFT_KEY);
            // ប្រសិនបើមានទិន្នន័យចាស់, ប្រើវា
            if (savedDrafts && JSON.parse(savedDrafts).length > 0) {
              return JSON.parse(savedDrafts);
            }
          } catch (e) {
            console.error("Failed to load drafts from localStorage:", e);
          }
          // បើមិនមាន, ចាប់ផ្តើមជាមួយជួរថ្មីមួយ
          return [createNewRow()];
        });

        // (NEW) បន្ថែម useEffect នេះ ដើម្បីរក្សាទុក 'rows' ទៅ localStorage រាល់ពេលវាផ្លាស់ប្តូរ
        useEffect(() => {
          try {
            localStorage.setItem(DRAFT_KEY, JSON.stringify(rows));
          } catch (e) {
            console.error("Failed to save drafts to localStorage:", e);
          }
        }, [rows, DRAFT_KEY]); // Dependency array

        // Update default expenseName in rows when templates load
        useEffect(() => {
          if (expenseTemplates.length > 0) {
            setRows(prevRows => 
              prevRows.map(row => ({
                ...row,
                // (FIX) រក្សា expenseName ដែលមានស្រាប់, បើមិនមានទេ ប្រើ default
                expenseName: row.expenseName || expenseTemplates[0].name
              }))
            );
          }
        // eslint-disable-next-line react-hooks/exhaustive-deps
        }, [expenseTemplates]); // មិនបាច់បន្ថែម createNewRow ទេ

        const handleUpdateRow = (id, field, value) => {
          setRows(prevRows =>
            prevRows.map(row =>
              row.id === id ? { ...row, [field]: value } : row
            )
          );
        };
        
        // --- Function សម្រាប់ xử lý input លេខ ---
        const handleAmountChange = (id, value) => {
          const cleanValue = parseAmount(value); // ប្រើ Global function
          
          // អនុញ្ញាតតែលេខ ឬ string ទទេ
          if (isNaN(cleanValue) && cleanValue !== '') {
            return; 
          }
          
          handleUpdateRow(id, 'amount', cleanValue);
        };
        // ------------------------------------------

        const handleAddRow = () => {
          setRows([...rows, createNewRow()]);
        };

        const handleDeleteRow = (id) => {
          setRows(prevRows => prevRows.filter(row => row.id !== id));
        };

        const handleSubmitAll = async () => {
          setLoading(true);
          const validRows = rows.filter(row => row.expenseName && row.amount > 0 && row.date);
          
          // ប្រើ Promise.all ដើម្បីឲ្យវាដំណើរការព្រមគ្នា
          try {
            await Promise.all(
              validRows.map(row => {
                const { id, ...expenseData } = row; // មិនរក្សាទុក ID បណ្តោះអាសន្ន
                // `expenseData.amount` គឺជាលេខសុទ្ធ (e.g., "1000000")
                return addExpense({
                  ...expenseData,
                  amount: parseFloat(expenseData.amount)
                });
              })
            );
            console.log(`Successfully added ${validRows.length} expenses.`);
            // (FIX) កូដនេះនឹង clear localStorage ដោយស្វ័យប្រវត្តិ ព្រោះ useEffect [rows] នឹងដំណើរការ
            setRows([createNewRow()]); // Reset តារាង
          } catch (error) {
            console.error("Error saving expenses: ", error);
          }
          setLoading(false);
        };

        return (
          <div className="mb-8 p-4 sm:p-6 bg-white shadow-md rounded-lg transition-all duration-300 ease-in-out hover:shadow-xl">
            <h2 className="text-2xl font-semibold mb-4 text-gray-800">តារាងបញ្ចូលចំណាយថ្មី</h2>
            
            {/* (FIX) បានប្តូរពី Table ទៅជា List សម្រាប់ Mobile */}
            <div className="">
              {/* HEADERS: លាក់នៅលើ Mobile, បង្ហាញនៅលើ Desktop */}
              <div className="hidden sm:table w-full">
                <div className="sm:table-header-group">
                  <div className="sm:table-row border-b-2 border-gray-300 bg-gray-100">
                    <div className="sm:table-cell p-3 font-semibold text-gray-700 text-left">ឈ្មោះចំណាយ</div>
                    <div className="sm:table-cell p-3 font-semibold text-gray-700 text-left">ចំនួនទឹកប្រាក់ (៛)</div>
                    <div className="sm:table-cell p-3 font-semibold text-gray-700 text-left">កាលបរិច្ឆេទ</div>
                    <div className="sm:table-cell p-3 font-semibold text-gray-700 text-center">លុប</div>
                  </div>
                </div>
              </div>

              {/* BODY: បង្ហាញជា Card នៅលើ Mobile, ជា Table Row នៅលើ Desktop */}
              <div className="sm:table w-full sm:border-collapse">
                <div className="sm:table-row-group">
                  {rows.map(row => (
                    // (FIX) រាល់ Row គឺជា Card នៅលើ Mobile (block), គឺជា Table Row នៅលើ Desktop
                    // (FIX) កាត់បន្ថយ Padding/Margin សម្រាប់ Mobile (p-2, mb-2)
                    <div key={row.id} className="block sm:table-row border shadow-md sm:shadow-none rounded-lg sm:rounded-none overflow-hidden mb-2 sm:mb-0 sm:border-b">
                      
                      {/* ឈ្មោះចំណាយ (Dropdown) */}
                      {/* (FIX) រាល់ Cell គឺជា Block នៅលើ Mobile, Table Cell នៅលើ Desktop */}
                      {/* (FIX) កាត់បន្ថយ Padding (p-2) */}
                      <div className="p-2 sm:p-2 block sm:table-cell border-b sm:border-none">
                        <label className="text-sm font-medium text-gray-600 sm:hidden">ឈ្មោះចំណាយ</label>
                        <select
                          value={row.expenseName}
                          onChange={(e) => handleUpdateRow(row.id, 'expenseName', e.target.value)}
                          className="w-full mt-1 sm:mt-0 p-2 border border-gray-300 rounded-md shadow-sm bg-white"
                        >
                          {expenseTemplates.length === 0 && <option value="" disabled>សូមបន្ថែមឈ្មោះចំណាយ...</option>}
                          {expenseTemplates.map((template) => (
                            <option key={template.id} value={template.name}>
                              {template.name}
                            </option>
                          ))}
                        </select>
                      </div>
                      
                      {/* កែប្រែ Input ចំនួនទឹកប្រាក់ */}
                      <div className="p-2 sm:p-2 block sm:table-cell border-b sm:border-none">
                        <label className="text-sm font-medium text-gray-600 sm:hidden">ចំនួនទឹកប្រាក់ (៛)</label>
                        <input
                          type="tel" 
                          inputMode="decimal"
                          value={formatDisplayAmount(row.amount)} 
                          onChange={(e) => handleAmountChange(row.id, e.target.value)} 
                          placeholder="0"
                          className="w-full mt-1 sm:mt-0 p-2 border border-gray-300 rounded-md shadow-sm"
                        />
                      </div>

                      {/* កាលបរិច្ឆេទ */}
                      <div className="p-2 sm:p-2 block sm:table-cell border-b sm:border-none">
                        <label className="text-sm font-medium text-gray-600 sm:hidden">កាលបរិច្ឆេទ</label>
                        <input
                          type="date"
                          value={row.date}
                          onChange={(e) => handleUpdateRow(row.id, 'date', e.target.value)}
                          className="w-full mt-1 sm:mt-0 p-2 border border-gray-300 rounded-md shadow-sm"
                        />
                      </div>
                      
                      {/* (FIX) ប៊ូតុងលុបជួរ: លាក់នៅលើ Mobile (hidden), បង្ហាញនៅលើ Desktop (sm:table-cell) */}
                      <div className="p-2 sm:p-2 hidden sm:table-cell text-right sm:text-center">
                        <button
                          onClick={() => handleDeleteRow(row.id)}
                          className="px-3 py-1.5 sm:py-1 bg-red-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-600 w-full sm:w-auto transition-transform duration-200 hover:scale-105 active:scale-95"
                        >
                          លុបជួរនេះ
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            
            <div className="flex flex-col sm:flex-row justify-between items-center mt-4 gap-2">
              {/* (FIX) ប៊ូតុងបន្ថែមជួរ: លាក់នៅលើ Mobile (hidden), បង្ហាញនៅលើ Desktop (sm:flex) */}
              <button
                onClick={handleAddRow}
                className="w-full sm:w-auto p-3 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 hidden sm:flex transition-transform duration-200 ease-in-out hover:scale-105 active:scale-95"
              >
                + បន្ថែមជួរថ្មី
              </button>
              
              {/* (FIX) ប៊ូតុងរក្សាទុក: ប្តូរអក្សរដោយផ្អែកលើទំហំអេក្រង់ */}
              <button
                onClick={handleSubmitAll}
                disabled={loading || rows.length === 0 || expenseTemplates.length === 0}
                className={`w-full sm:w-auto p-3 text-white font-semibold rounded-md shadow-md transition-all duration-200 ease-in-out active:scale-95 ${
                  (loading || expenseTemplates.length === 0)
                    ? 'bg-gray-400 cursor-not-allowed' 
                    : 'bg-blue-600 hover:bg-blue-700 hover:scale-105'
                }`}
              >
                {loading ? 'កំពុងរក្សាទុក...' : (expenseTemplates.length === 0 ? 'ត្រូវបន្ថែមឈ្មោះចំណាយសិន' : (
                  <>
                    <span className="hidden sm:inline">រក្សាទុកទាំងអស់</span>
                    <span className="inline sm:hidden">រក្សាទុក</span>
                  </>
                ))}
              </button>
            </div>
          </div>
        );
      }
      
      
      // --- Component សម្រាប់ Filter ---
      function ExpenseFilter({ filterType, setFilterType, filterValue, setFilterValue }) {
        
        // យកខែ/ឆ្នាំ បច្ចុប្បន្នសម្រាប់ Default
        const today = new Date();
        const currentDay = today.toISOString().split('T')[0];
        const currentMonth = today.toISOString().slice(0, 7); // "2025-11"
        const currentYear = today.getFullYear().toString();

        // កំណត់ Default ពេល Component បើកដំបូង
        useEffect(() => {
          if (!filterValue) {
            setFilterValue(currentDay);
          }
        // eslint-disable-next-line react-hooks/exhaustive-deps
        }, []);
        
        const handleTypeChange = (e) => {
          const newType = e.target.value;
          setFilterType(newType);
          // កំណត់ Default Value ពេលប្តូរ Type
          switch (newType) {
            case 'daily':
              setFilterValue(currentDay);
              break;
            case 'monthly':
              setFilterValue(currentMonth);
              break;
            case 'yearly':
              setFilterValue(currentYear);
              break;
            case 'all':
              setFilterValue('all');
              break;
            default:
              setFilterValue(currentDay);
          }
        };

        const renderFilterInput = () => {
          switch (filterType) {
            case 'daily':
              return (
                <input
                  type="date"
                  value={filterValue}
                  onChange={(e) => setFilterValue(e.target.value)}
                  className="p-2 border border-gray-300 rounded-md shadow-sm w-full"
                />
              );
            case 'monthly':
              return (
                <input
                  type="month"
                  value={filterValue}
                  onChange={(e) => setFilterValue(e.target.value)}
                  className="p-2 border border-gray-300 rounded-md shadow-sm w-full"
                />
              );
            case 'yearly':
              return (
                <input
                  type="number"
                  value={filterValue}
                  onChange={(e) => setFilterValue(e.target.value)}
                  placeholder="YYYY"
                  min="2000"
                  max="2100"
                  step="1"
                  className="p-2 border border-gray-300 rounded-md shadow-sm w-full"
                />
              );
            case 'all':
              return <p className="p-2 text-gray-500 w-full text-center sm:text-left">បង្ហាញទិន្នន័យទាំងអស់</p>;
            default:
              return null;
          }
        };

        return (
          <div className="p-4 bg-white shadow-md rounded-lg mb-8 transition-all duration-300 ease-in-out hover:shadow-xl">
            <div className="flex flex-col sm:flex-row gap-4">
              {/* ជម្រើសប្រភេទ Filter */}
              <div className="flex-1">
                <label htmlFor="filterType" className="block text-sm font-medium text-gray-700 mb-1">
                  ជ្រើសរើសរបៀបបង្ហាញ
                </label>
                <select
                  id="filterType"
                  value={filterType}
                  onChange={handleTypeChange}
                  className="p-2 border border-gray-300 rounded-md shadow-sm w-full bg-white"
                >
                  <option value="daily">ប្រចាំថ្ងៃ</option>
                  <option value="monthly">ប្រចាំខែ</option>
                  <option value="yearly">ប្រចាំឆ្នាំ</option>
                  <option value="all">សរុបទាំងអស់</option>
                </select>
              </div>
              
              {/* ជម្រើស Value (ថ្ងៃ, ខែ, ឆ្នាំ) */}
              <div className="flex-1">
                <label htmlFor="filterValue" className="block text-sm font-medium text-gray-700 mb-1">
                  ជ្រើសរើស
                </label>
                {renderFilterInput()}
              </div>
            </div>
          </div>
        );
      }

      // --- (NEW) Component សម្រាប់កែសម្រួលទិន្នន័យ (Desktop: Table Row) ---
      function EditableExpenseRow({ expense, deleteExpense, updateExpense, expenseTemplates }) {
        const [isEditing, setIsEditing] = useState(false);
        const [editData, setEditData] = useState({ ...expense });

        const handleAmountChange = (value) => {
          const cleanValue = parseAmount(value);
          if (isNaN(cleanValue) && cleanValue !== '') return;
          setEditData(prev => ({ ...prev, amount: cleanValue }));
        };

        const handleSave = async () => {
          const dataToUpdate = {
            expenseName: editData.expenseName,
            date: editData.date,
            amount: parseFloat(editData.amount)
          };
          await updateExpense(expense.id, dataToUpdate);
          setIsEditing(false);
        };

        const handleCancel = () => {
          setIsEditing(false);
          setEditData({ ...expense }); // Reset to original data
        };

        // ធ្វើ Format កាលបរិច្ឆេទ
        const formattedDate = new Date(expense.date).toLocaleDateString('km-KH', {
          year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
        });
        
        // ធ្វើ Format លុយរៀល
        const amountValue = typeof expense.amount === 'number' ? expense.amount : parseFloat(expense.amount);
        const formattedAmount = isNaN(amountValue) ? 'N/A' : amountValue.toLocaleString('km-KH');

        if (isEditing) {
          return (
            <tr className="border-b border-gray-200 bg-blue-50">
              {/* Edit: ឈ្មោះចំណាយ */}
              <td className="p-3 py-2">
                <select
                  value={editData.expenseName}
                  onChange={(e) => setEditData(prev => ({ ...prev, expenseName: e.target.value }))}
                  className="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white"
                >
                  {expenseTemplates.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                </select>
              </td>
              {/* Edit: កាលបរិច្ឆេទ */}
              <td className="p-3 py-2">
                <input
                  type="date"
                  value={editData.date}
                  onChange={(e) => setEditData(prev => ({ ...prev, date: e.target.value }))}
                  className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                />
              </td>
              {/* Edit: ចំនួនទឹកប្រាក់ */}
              <td className="p-3 py-2">
                <input
                  type="tel"
                  inputMode="decimal"
                  value={formatDisplayAmount(editData.amount)}
                  onChange={(e) => handleAmountChange(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                />
              </td>
              {/* Edit: ប៊ូតុង */}
              <td className="p-3 py-2 text-center">
                <div className="flex justify-center gap-2">
                  <button
                    onClick={handleSave}
                    className="px-3 py-1 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 transition-transform duration-200 hover:scale-105 active:scale-95"
                  >
                    រក្សាទុក
                  </button>
                  <button
                    onClick={handleCancel}
                    className="px-3 py-1 bg-gray-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-600 transition-transform duration-200 hover:scale-105 active:scale-95"
                  >
                    បោះបង់
                  </button>
                </div>
              </td>
            </tr>
          );
        }

        // ពេលមិនមែន Edit (Default View)
        return (
          <tr className="border-b border-gray-200 hover:bg-gray-50">
            <td className="p-3 py-4 text-gray-900">{expense.expenseName}</td>
            <td className="p-3 py-4 text-gray-600">{formattedDate}</td>
            <td className="p-3 py-4 text-red-600 font-bold">{formattedAmount} ៛</td>
            <td className="p-3 py-4 text-center">
              <div className="flex justify-center gap-2">
                <button
                  onClick={() => setIsEditing(true)}
                  className="px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-yellow-600 transition-transform duration-200 hover:scale-105 active:scale-95"
                >
                  កែសម្រួល
                </button>
                <button
                  onClick={() => deleteExpense(expense.id)}
                  className="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-600 transition-transform duration-200 hover:scale-105 active:scale-95"
                >
                  លុប
                </button>
              </div>
            </td>
          </tr>
        );
      }
      
      // --- (NEW) Component សម្រាប់កែសម្រួលទិន្នន័យ (Mobile: Card) ---
      function EditableExpenseCard({ expense, deleteExpense, updateExpense, expenseTemplates }) {
        const [isEditing, setIsEditing] = useState(false);
        const [editData, setEditData] = useState({ ...expense });

        const handleAmountChange = (value) => {
          const cleanValue = parseAmount(value);
          if (isNaN(cleanValue) && cleanValue !== '') return;
          setEditData(prev => ({ ...prev, amount: cleanValue }));
        };

        const handleSave = async () => {
          const dataToUpdate = {
            expenseName: editData.expenseName,
            date: editData.date,
            amount: parseFloat(editData.amount)
          };
          await updateExpense(expense.id, dataToUpdate);
          setIsEditing(false);
        };
        
        const handleCancel = () => {
          setIsEditing(false);
          setEditData({ ...expense }); // Reset to original data
        };

        // ធ្វើ Format កាលបរិច្ឆេទ
        const formattedDate = new Date(expense.date).toLocaleDateString('km-KH', {
          year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
        });
        
        // ធ្វើ Format លុយរៀល
        const amountValue = typeof expense.amount === 'number' ? expense.amount : parseFloat(expense.amount);
        const formattedAmount = isNaN(amountValue) ? 'N/A' : amountValue.toLocaleString('km-KH');

        return (
          <div className={`p-4 bg-white shadow-md rounded-lg mb-3 transition-all duration-300 ease-in-out hover:shadow-xl ${isEditing ? 'border-2 border-blue-500' : ''}`}>
            {isEditing ? (
              // -- ទម្រង់ Edit (Card) --
              <div className="space-y-3">
                {/* Edit: ឈ្មោះចំណាយ */}
                <div>
                  <label className="text-sm font-medium text-gray-600">ឈ្មោះចំណាយ</label>
                  <select
                    value={editData.expenseName}
                    onChange={(e) => setEditData(prev => ({ ...prev, expenseName: e.target.value }))}
                    className="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm bg-white"
                  >
                    {expenseTemplates.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                  </select>
                </div>
                
                {/* Edit: ចំនួនទឹកប្រាក់ */}
                <div>
                  <label className="text-sm font-medium text-gray-600">ចំនួនទឹកប្រាក់ (៛)</label>
                  <input
                    type="tel"
                    inputMode="decimal"
                    value={formatDisplayAmount(editData.amount)}
                    onChange={(e) => handleAmountChange(e.target.value)}
                    className="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm"
                  />
                </div>
                
                {/* Edit: កាលបរិច្ឆេទ */}
                <div>
                  <label className="text-sm font-medium text-gray-600">កាលបរិច្ឆេទ</label>
                  <input
                    type="date"
                    value={editData.date}
                    onChange={(e) => setEditData(prev => ({ ...prev, date: e.target.value }))}
                    className="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm"
                  />
                </div>
                
                {/* Edit: ប៊ូតុង */}
                <div className="flex justify-end gap-2 pt-2">
                  <button
                    onClick={handleCancel}
                    className="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-600 transition-transform duration-200 hover:scale-105 active:scale-95"
                  >
                    បោះបង់
                  </button>
                  <button
                    onClick={handleSave}
                    className="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 transition-transform duration-200 hover:scale-105 active:scale-95"
                  >
                    រក្សាទុក
                  </button>
                </div>
              </div>
            ) : (
              // -- ទម្រង់បង្ហាញ (Card) --
              <div>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-semibold text-gray-900">{expense.expenseName}</span>
                  <span className="text-lg font-bold text-red-700">{formattedAmount} ៛</span>
                </div>
                <p className="text-sm text-gray-600 mb-4">{formattedDate}</p>
                <div className="flex justify-end gap-2">
                  <button
                    onClick={() => setIsEditing(true)}
                    className="px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-yellow-600 transition-transform duration-200 hover:scale-105 active:scale-95"
                  >
                    កែសម្រួល
                  </button>
                  <button
                    onClick={() => deleteExpense(expense.id)}
                    className="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-600 transition-transform duration-200 hover:scale-105 active:scale-95"
                  >
                    លុប
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }
      
      
      // (NEW) Component សម្រាប់ Pagination Controls
      function PaginationControls({ currentPage, totalPages, setCurrentPage }) {
        if (totalPages <= 1) return null; // មិនបាច់បង្ហាញទេ បើមានតែ១ទំព័រ

        return (
          <div className="mt-6 flex justify-between items-center">
            {/* Previous Button (Desktop) */}
            <button
              onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
              disabled={currentPage === 1}
              className="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
              ទំព័រមុន
            </button>
            
            {/* Page Indicator (Mobile & Desktop) */}
            <span className="text-sm font-semibold text-gray-700">
              ទំព័រ {currentPage} នៃ {totalPages}
            </span>
            
            {/* Next Button (Desktop) */}
            <button
              onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
              disabled={currentPage === totalPages}
              className="hidden sm:inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all"
            >
              ទំព័របន្ទាប់
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        );
      }


      // --- (FIX) Component សម្រាប់បង្ហាញបញ្ជីចំណាយ (បានកែប្រែ) ---
      function ExpenseList({ expenses, deleteExpense, updateExpense, expenseTemplates, loading, filterType, filterValue }) {
        
        // (NEW) Pagination state
        const [listPage, setListPage] = useState(1);
        const [touchStartX, setTouchStartX] = useState(0);
        const [touchEndX, setTouchEndX] = useState(0);
        const ITEMS_PER_PAGE = 10;
        
        // (NEW) ត្រង (Filter) ទិន្នន័យ
        const filteredExpenses = useMemo(() => {
          if (loading || !filterValue) return [];
          
          return expenses.filter(expense => {
            // const expenseDate = new Date(expense.date); // មិនចាំបាច់
            
            switch (filterType) {
              case 'daily':
                // ត្រូវប្រាកដថា expense.date (e.g., "2025-11-03") គឺដូច filterValue
                return expense.date === filterValue;
              
              case 'monthly':
                // យក "YYYY-MM" ពី expense.date
                const expenseMonth = expense.date.slice(0, 7); // "2025-11"
                return expenseMonth === filterValue;
              
              case 'yearly':
                // យក "YYYY" ពី expense.date
                const expenseYear = expense.date.slice(0, 4); // "2025"
                return expenseYear === filterValue;
              
              case 'all':
                return true;
                
              default:
                return false;
            }
          });
        }, [expenses, filterType, filterValue, loading]);
        
        // (NEW) Sort and Paginate
        const sortedExpenses = useMemo(() => {
          return filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
        }, [filteredExpenses]);

        const totalPages = Math.ceil(sortedExpenses.length / ITEMS_PER_PAGE);

        // (NEW) Reset to page 1 if filter changes and current page is out of bounds
        useEffect(() => {
          if (listPage > totalPages) {
            setListPage(1);
          }
        }, [listPage, totalPages]);
        
        // (NEW) Reset to page 1 if filter *value* changes
        useEffect(() => {
          setListPage(1);
        }, [filterType, filterValue]);

        const paginatedExpenses = useMemo(() => {
          const startIndex = (listPage - 1) * ITEMS_PER_PAGE;
          const endIndex = startIndex + ITEMS_PER_PAGE;
          return sortedExpenses.slice(startIndex, endIndex);
        }, [sortedExpenses, listPage]);

        // (NEW) Touch Handlers
        const handleTouchStart = (e) => {
          setTouchStartX(e.targetTouches[0].clientX);
          setTouchEndX(e.targetTouches[0].clientX); // Reset endX
        };
        
        const handleTouchMove = (e) => {
          setTouchEndX(e.targetTouches[0].clientX);
        };
        
        const handleTouchEnd = () => {
          if (touchStartX - touchEndX > 75) { // Swipe Left
            // Next page
            setListPage(prev => {
              const newPage = Math.min(prev + 1, totalPages || 1);
              return newPage;
            });
          }
        
          if (touchEndX - touchStartX > 75) { // Swipe Right
            // Previous page
            setListPage(prev => {
              const newPage = Math.max(prev - 1, 1);
              return newPage;
            });
          }
        };
        
        return (
          <div className="p-0 sm:p-6 sm:bg-white sm:shadow-md sm:rounded-lg transition-all duration-300 sm:hover:shadow-xl">
            <h2 className="text-2xl font-semibold mb-4 text-gray-800 p-6 sm:p-0">បញ្ជីចំណាយ</h2>
            {loading ? (
              <p className="text-center text-gray-500">កំពុងទាញទិន្ន័យ...</p>
            ) : sortedExpenses.length === 0 ? ( // (FIX) Use sortedExpenses
              <p className="text-center text-gray-500">មិនមានទិន្នន័យសម្រាប់ជម្រើសនេះទេ។</p>
            ) : (
              <>
                {/* (FIX) ទម្រង់តារាង (Desktop) - លាក់នៅលើ Mobile */}
                <div className="hidden sm:block overflow-x-auto">
                  <table className="w-full min-w-[600px] table-auto text-left">
                    <thead className="border-b-2 border-gray-300 bg-gray-100">
                      <tr>
                        <th className="p-3 font-semibold text-gray-700">ឈ្មោះចំណាយ</th>
                        <th className="p-3 font-semibold text-gray-700">កាលបរិច្ឆេទ</th>
                        <th className="p-3 font-semibold text-gray-700">ចំនួនទឹកប្រាក់</th>
                        <th className="p-3 font-semibold text-gray-700 text-center">សកម្មភាព</th>
                      </tr>
                    </thead>
                    <tbody>
                      {paginatedExpenses.map((expense) => ( // (FIX) Use paginatedExpenses
                        <EditableExpenseRow
                          key={expense.id}
                          expense={expense}
                          deleteExpense={deleteExpense}
                          updateExpense={updateExpense}
                          expenseTemplates={expenseTemplates}
                        />
                      ))}
                    </tbody>
                  </table>
                </div>
                
                {/* (FIX) ទម្រង់ Card (Mobile) - លាក់នៅលើ Desktop */}
                <div 
                  className="block sm:hidden -mx-4 sm:mx-0"
                  onTouchStart={handleTouchStart} // (NEW) Add touch handler
                  onTouchMove={handleTouchMove}   // (NEW) Add touch handler
                  onTouchEnd={handleTouchEnd}     // (NEW) Add touch handler
                >
                  {paginatedExpenses.map((expense) => ( // (FIX) Use paginatedExpenses
                    <EditableExpenseCard
                      key={expense.id}
                      expense={expense}
                      deleteExpense={deleteExpense}
                      updateExpense={updateExpense}
                      expenseTemplates={expenseTemplates}
                    />
                  ))}
                </div>
                
                {/* (NEW) Pagination Controls */}
                <PaginationControls 
                  currentPage={listPage}
                  totalPages={totalPages}
                  setCurrentPage={setListPage}
                />
              </>
            )}
          </div>
        );
      }

      // --- Component សម្រាប់បង្ហាញការសរុប (បានកែប្រែ) ---
      function ExpenseSummary({ expenses, filterType, filterValue, loading }) {
        
        // (NEW) ត្រង (Filter) ទិន្នន័យ
        const filteredExpenses = useMemo(() => {
          if (loading || !filterValue) return [];
          
          return expenses.filter(expense => {
            // const expenseDate = new Date(expense.date); // មិនចាំបាច់
            
            switch (filterType) {
              case 'daily':
                return expense.date === filterValue;
              case 'monthly':
                const expenseMonth = expense.date.slice(0, 7); // "2025-11"
                return expenseMonth === filterValue;
              case 'yearly':
                const expenseYear = expense.date.slice(0, 4); // "2025"
                return expenseYear === filterValue;
              case 'all':
                return true;
              default:
                return false;
            }
          });
        }, [expenses, filterType, filterValue, loading]);

        // គណនាផលបូកសរុប (ពីទិន្នន័យដែលបាន Filter)
        const totalExpense = useMemo(() => {
          // (FIX) ត្រូវប្រាកដថាបូកជាលេខ
          return filteredExpenses.reduce((total, expense) => {
             const amountValue = typeof expense.amount === 'number' ? expense.amount : parseFloat(expense.amount);
             return total + (isNaN(amountValue) ? 0 : amountValue);
          }, 0);
        }, [filteredExpenses]);
        
        // (NEW) បង្កើតចំណងជើង
        const summaryTitle = useMemo(() => {
          if (!filterValue) return "សរុបចំណាយ";
          
          try {
            switch (filterType) {
              case 'daily':
                const date = new Date(filterValue);
                const formattedDate = date.toLocaleDateString('km-KH', { 
                  year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' 
                });
                return `សរុបចំណាយថ្ងៃទី ${formattedDate}`;
              case 'monthly':
                const [year, month] = filterValue.split('-');
                const monthDate = new Date(year, month - 1);
                const formattedMonth = monthDate.toLocaleDateString('km-KH', { 
                  year: 'numeric', month: 'long', timeZone: 'UTC' 
                });
                return `សរុបចំណាយខែ ${formattedMonth}`;
              case 'yearly':
                return `សរុបចំណាយឆ្នាំ ${filterValue}`;
              case 'all':
                return "សរុបចំណាយទាំងអស់";
              default:
                return "សរុបចំណាយ";
            }
          } catch (e) {
            console.error("Date formatting error:", e);
            return "សរុបចំណាយ";
          }
        }, [filterType, filterValue]);

        return (
          <div className="p-6 bg-white shadow-md rounded-lg mb-8 transition-all duration-300 ease-in-out hover:shadow-xl">
            <h2 className="text-xl sm:text-2xl font-semibold text-gray-800">{summaryTitle}</h2>
            <p className="text-4xl font-bold text-red-700 mt-2">
              {totalExpense.toLocaleString('km-KH')} ៛
            </p>
          </div>
        );
      }

      // --- (FIX) Component សម្រាប់ Navigation Bar ---
      function Navbar({ currentPage, setCurrentPage }) {
        const navItems = [
          { id: 'dashboard', label: 'ផ្ទាំងសរុប' }, // ប្តូរ
          { id: 'list', label: 'បញ្ជីចំណាយ' }, // ថ្មី
          { id: 'add', label: 'បន្ថែមចំណាយ' },
          { id: 'templates', label: 'គ្រប់គ្រងឈ្មោះ' }, // ប្តូរ
        ];

        const getButtonClass = (pageId) => {
          const baseClass = "flex-1 p-3 sm:p-4 text-center font-semibold transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transform hover:scale-105";
          if (pageId === currentPage) {
            return `${baseClass} bg-blue-700 text-white scale-105 shadow-inner`; // បន្ថែម shadow ពេល Active
          }
          return `${baseClass} bg-white text-blue-600 hover:bg-gray-100`;
        };

        return (
          <nav className="mb-8 bg-white shadow-md rounded-lg overflow-hidden hidden sm:flex divide-x divide-gray-200">
            {navItems.map((item, index) => (
              <button
                key={item.id}
                onClick={() => setCurrentPage(item.id)}
                className={`${getButtonClass(item.id)} ${
                  index === 0 ? 'rounded-l-lg' : ''
                } ${index === navItems.length - 1 ? 'rounded-r-lg' : ''}`}
              >
                {item.label}
              </button>
            ))}
          </nav>
        );
      }
      
      // --- (FIX) Component សម្រាប់ Mobile Bottom Navigation Bar ---
      function MobileNavbar({ currentPage, setCurrentPage }) {
        const navItems = [
          { id: 'dashboard', label: 'សរុប', icon: ( // ប្តូរ
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4z" />
            </svg>
          )},
          { id: 'list', label: 'បញ្ជី', icon: ( // ថ្មី
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
          )},
          { id: 'add', label: 'បន្ថែម', icon: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          )},
          { id: 'templates', label: 'គ្រប់គ្រង', icon: (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          )},
        ];
        
        const getButtonClass = (pageId) => {
          const baseClass = "flex flex-col items-center justify-center flex-1 py-2 transition-all duration-300 ease-in-out focus:outline-none transform active:scale-90";
          if (pageId === currentPage) {
            return `${baseClass} text-blue-700 scale-110`; // Active
          }
          return `${baseClass} text-gray-500 hover:text-blue-600 hover:scale-110`; // Inactive
        };

        return (
          <nav className="sm:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 flex justify-around">
            {navItems.map(item => (
              <button
                key={item.id}
                onClick={() => setCurrentPage(item.id)}
                className={getButtonClass(item.id)}
              >
                {item.icon}
                <span className="text-xs font-medium">{item.label}</span>
              </button>
            ))}
          </nav>
        );
      }


      // --- Main App Component ---
      // (FIX) Đã xóa 'export default'
      function App() {
        const [expenses, setExpenses] = useState([]);
        const [expenseTemplates, setExpenseTemplates] = useState([]); // កែប្រែពី categories
        const [userId, setUserId] = useState(null);
        // const [isAuthReady, setIsAuthReady] = useState(false); // មិនត្រូវការសម្រាប់ data fetching ទៀតទេ
        const [loading, setLoading] = useState(true); // សម្រាប់ពេលកំពុងទាញទិន្នន័យ
        const [submitLoading, setSubmitLoading] = useState(false); // សម្រាប់ពេលកំពុង Submit
        const [currentPage, setCurrentPage] = useState('dashboard'); // State សម្រាប់ Page
        
        // (NEW) States សម្រាប់ Filter
        const [filterType, setFilterType] = useState('daily');
        const [filterValue, setFilterValue] = useState(new Date().toISOString().split('T')[0]); // Default ថ្ងៃនេះ
        // (NEW) State សម្រាប់លាក់/បង្ហាញ Filter នៅលើទំព័រ 'list' (Mobile)
        const [isListFilterVisible, setIsListFilterVisible] = useState(false);

        // 1. ដំណើរការ Authentication (សម្រាប់បង្ហាញ User ID)
        useEffect(() => {
          if (!auth) {
            console.log("Auth is not ready");
            return;
          }

          // (FIX) ប្រើ v8/compat syntax
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            if (user) {
              console.log("User is signed in with UID:", user.uid);
              setUserId(user.uid);
              // setIsAuthReady(true);
            } else {
              console.log("No user signed in, attempting sign in...");
              try {
                if (initialAuthToken) {
                  // (FIX) ប្រើ v8/compat syntax
                  await auth.signInWithCustomToken(initialAuthToken);
                  console.log("Signed in with custom token.");
                } else {
                  // (FIX) ប្រើ v8/compat syntax
                  await auth.signInAnonymously();
                  console.log("Signed in anonymously.");
                }
              } catch (error) {
                console.error("Error signing in: ", error);
                // setIsAuthReady(true);
              }
            }
          });

          return () => unsubscribe();
        }, []);
        

        // 2. ភ្ជាប់ទៅ Firebase (Realtime DB សម្រាប់ទិន្នន័យទាំងអស់)
        // លុប useEffect ទីមួយដែលអាស្រ័យលើ isAuthReady
        
        useEffect(() => {
          // ដំណើរការ Templates និង Expenses ភ្លាមៗ (Public)
          if (!rtdb) {
            console.log("RTDB not ready");
            return;
          }
          
          setLoading(true);
          
          // --- Listener សម្រាប់ ExpenseTemplates (Public - Realtime Database) ---
          console.log(`Setting up RTDB listener for public headers: artifacts/${appId}/public/expenseTemplates`);
          // (FIX) ប្រើ v8/compat syntax
          const templatesRef = rtdb.ref(`artifacts/${appId}/public/expenseTemplates`);
          const unsubscribeTemplates = templatesRef.on('value', 
            (snapshot) => {
              const templatesData = [];
              if (snapshot.exists()) {
                const data = snapshot.val();
                // បំប្លែង Object ទៅ Array
                for (const key in data) {
                  templatesData.push({ id: key, ...data[key] });
                }
              }
              // តម្រៀបតាមពេលបង្កើត
              templatesData.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
              setExpenseTemplates(templatesData);
              console.log("Public templates loaded:", templatesData.length);
            },
            (error) => {
              console.error("Error fetching expense templates from RTDB: ", error);
            }
          );

          // --- (កែប្រែ) Listener សម្រាប់ Expenses (Public - Realtime Database) ---
          console.log(`Setting up RTDB listener for public expenses: artifacts/${appId}/public/expenses`);
          // (FIX) ប្រើ v8/compat syntax
          const expensesRef = rtdb.ref(`artifacts/${appId}/public/expenses`);
          const unsubscribeExpenses = expensesRef.on('value', 
            (snapshot) => {
              const expensesData = [];
              if (snapshot.exists()) {
                const data = snapshot.val();
                for (const key in data) {
                  expensesData.push({ id: key, ...data[key] });
                }
              }
              // (FIX) Sort មិនចាំបាច់នៅទីនេះទេ ព្រោះ data ទាំងអស់នឹងត្រូវ Filter  anyway
              // expensesData.sort((a, b) => new Date(b.date) - new Date(a.date));
              setExpenses(expensesData);
              setLoading(false); // ដាក់ Loading false បន្ទាប់ពីទាញ Expenses រួច
            },
            (error) => {
              console.error("Error fetching expenses from RTDB: ", error);
              setLoading(false);
            }
          );

          // Cleanup listener
          return () => {
            console.log("Cleaning up RTDB listeners.");
            // (FIX) ប្រើ v8/compat syntax សម្រាប់ .off()
            templatesRef.off('value', unsubscribeTemplates);
            expensesRef.off('value', unsubscribeExpenses);
          };
        }, []); // ដំណើរការតែម្តងពេល component mount

        // --- (កែប្រែ) Function សម្រាប់បន្ថែមចំណាយ (រក្សាទុកក្នុង RTDB - Public) ---
        const addExpense = async (expense) => {
          if (!rtdb) return Promise.reject("RTDB not ready");
          
          // បន្ថែម userId ទៅក្នុងទិន្នន័យ public
          const expenseData = {
            ...expense,
            // (FIX) ប្រើ v8/compat syntax
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            addedBy: userId || 'anonymous' // តាមដានអ្នកដែលបានបន្ថែម
          };

          try {
            const collectionPath = `artifacts/${appId}/public/expenses`;
            // (FIX) ប្រើ v8/compat syntax
            const newExpenseRef = rtdb.ref(collectionPath).push();
            await newExpenseRef.set(expenseData);
          } catch (error) {
            console.error("Error adding document to RTDB: ", error);
            return Promise.reject(error); // សម្រាប់ Promise.all
          }
        };

        // --- (កែប្រែ) Function សម្រាប់លុបចំណាយ (ពី RTDB - Public) ---
        const deleteExpense = async (id) => {
          if (!rtdb) return;
          try {
            const docPath = `artifacts/${appId}/public/expenses/${id}`;
            // (FIX) ប្រើ v8/compat syntax
            await rtdb.ref(docPath).remove();
          } catch (error) {
            console.error("Error deleting document from RTDB: ", error);
          }
        };
        
        // --- (NEW) Function សម្រាប់កែសម្រួលចំណាយ (ពី RTDB - Public) ---
        const updateExpense = async (id, dataToUpdate) => {
          if (!rtdb) return;
          // dataToUpdate គួរតែជា object ដូចជា { expenseName, date, amount }
          try {
            const docPath = `artifacts/${appId}/public/expenses/${id}`;
            // (FIX) ប្រើ v8/compat syntax
            await rtdb.ref(docPath).update(dataToUpdate);
            console.log("Updated expense:", id);
          } catch (error) {
            console.error("Error updating document in RTDB: ", error);
          }
        };
        
        // --- Function សម្រាប់បន្ថែមឈ្មោះចំណាយ (រក្សាទុកក្នុង RTDB - Public) ---
        const addExpenseTemplate = async (name) => {
          if (!rtdb || !name.trim()) return;
          try {
            const collectionPath = `artifacts/${appId}/public/expenseTemplates`;
            // (FIX) ប្រើ v8/compat syntax
            const newTemplateRef = rtdb.ref(collectionPath).push(); // បង្កើត key ថ្មី
            await newTemplateRef.set({ 
              name: name.trim(), 
              // (FIX) ប្រើ v8/compat syntax
              createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            console.log("Added public template:", name);
          } catch (error)
          {
            console.error("Error adding expense template to RTDB: ", error);
          }
        };
        
        // --- Function សម្រាប់លុបឈ្មោះចំណាយ (ពី RTDB - Public) ---
        // (មិនបាច់កែប្រែទេ ព្រោះវាត្រឹមត្រូវហើយ)
        const deleteExpenseTemplate = async (id) => {
          if (!rtdb) return;
          try {
            const docPath = `artifacts/${appId}/public/expenseTemplates/${id}`;
            // (FIX) ប្រើ v8/compat syntax
            await rtdb.ref(docPath).remove();
            console.log("Deleted public template:", id);
          } catch (error) {
            console.error("Error deleting expense template from RTDB: ", error);
          }
        };

        return (
          // (FIX) បន្ថែម pb-24 (padding-bottom: 6rem) ដើម្បីកុំឱ្យ MobileNavbar គ្របលើមាតិកា
          <div className="min-h-screen bg-gray-100 p-4 sm:p-8 pb-24 sm:pb-8">
            <div className="max-w-6xl mx-auto">
              <header className="mb-8 text-center">
                <h1 className="text-4xl font-bold text-blue-700">កម្មវិធីកត់ត្រាចំណាយ</h1>
                {/* (FIX) បានប្តូរអត្ថបទ និងលុប User ID */}
                <p className="text-lg text-gray-600">ចំណាយប្រចាំខែ DUC</p>
                {/* {userId && (
                  <p className="text-xs text-gray-400 mt-2">User ID: {userId}</p>
                )} */}
              </header>
              
              {/* Navigation Bar (Desktop) */}
              <Navbar currentPage={currentPage} setCurrentPage={setCurrentPage} />

              <main>
                {/* (FIX) បង្ហាញ Page ដោយផ្អែកលើ State ជាមួយ Animation */}
                <div key={currentPage} className="page-fade-in">

                  {currentPage === 'dashboard' && (
                    <>
                      {/* (FIX) Page នេះឥឡូវសម្រាប់តែ Filter និង Summary */}
                      <ExpenseFilter 
                        filterType={filterType}
                        setFilterType={setFilterType}
                        filterValue={filterValue}
                        setFilterValue={setFilterValue}
                      />
                      <ExpenseSummary 
                        expenses={expenses} 
                        loading={loading}
                        filterType={filterType}
                        filterValue={filterValue}
                      />
                    </>
                  )}
                  
                  {/* (NEW) Page ថ្មីសម្រាប់ បញ្ជីចំណាយ */}
                  {currentPage === 'list' && (
                    <>
                      {/* (NEW) Filter Toggle Button for Mobile */}
                      <div className="sm:hidden mb-4">
                        <button 
                          onClick={() => setIsListFilterVisible(!isListFilterVisible)}
                          className="w-full p-3 bg-white text-blue-600 font-semibold rounded-md shadow-md flex items-center justify-center gap-2 transition-all duration-300 active:scale-95"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V19l-4 2v-5.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                          </svg>
                          {isListFilterVisible ? 'លាក់ប្រអប់ស្វែងរក' : 'បង្ហាញប្រអប់ស្វែងរក'}
                        </button>
                      </div>
                      
                      {/* (NEW) Conditional Filter for Mobile */}
                      {isListFilterVisible && (
                        <div className="sm:hidden page-fade-in">
                          <ExpenseFilter 
                            filterType={filterType}
                            setFilterType={setFilterType}
                            filterValue={filterValue}
                            setFilterValue={setFilterValue}
                          />
                        </div>
                      )}
                      
                      {/* (NEW) Always-on Filter for Desktop */}
                      <div className="hidden sm:block">
                        <ExpenseFilter 
                          filterType={filterType}
                          setFilterType={setFilterType}
                          filterValue={filterValue}
                          setFilterValue={setFilterValue}
                        />
                      </div>
                    
                      <ExpenseList 
                        expenses={expenses} 
                        deleteExpense={deleteExpense} 
                        updateExpense={updateExpense}
                        expenseTemplates={expenseTemplates}
                        loading={loading}
                        filterType={filterType}
                        filterValue={filterValue}
                      />
                    </>
                  )}

                  {currentPage === 'add' && (
                    <>
                      {/* Page បន្ថែមចំណាយ */}
                      <BatchExpenseForm 
                        addExpense={addExpense}
                        expenseTemplates={expenseTemplates}
                        loading={submitLoading}
                        setLoading={setSubmitLoading}
                      />
                    </>
                  )}

                  {currentPage === 'templates' && ( // កែប្រែពី 'categories'
                    <>
                      {/* Page គ្រប់គ្រងឈ្មោះចំណាយ */}
                      <ExpenseTemplateManager 
                        expenseTemplates={expenseTemplates}
                        addExpenseTemplate={addExpenseTemplate}
                        deleteExpenseTemplate={deleteExpenseTemplate}
                      />
                    </>
                  )}
                
                </div>
              </main>

              {/* (NEW) Mobile Navigation Bar */}
              <MobileNavbar currentPage={currentPage} setCurrentPage={setCurrentPage} />
            </div>
          </div>
        );
      }

      // --- 7. Render App ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);

  </script>

</body>
</html>

